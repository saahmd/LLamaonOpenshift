---
- name: Deploy a Kafka container with Podman using KRaft mode and External Access
  hosts: all
  become: true
  vars:
    kafka_container_name: cp-kafka
    kafka_image: "docker.io/apache/kafka"
    kafka_port: 9092
    kafka_controller_port: 9093
    # Variables for External Access:
    kafka_external_port: 9094 # <-- New port for external clients
    # CRITICAL: Replace with your actual public hostname or IP
    kafka_path: "/opt/kafka/bin/"
    kafka_topics:
      - "httpd-error-logs"
      - "ai-ran-logs"

  tasks:
    - name: Ensure required packages are installed
      ansible.builtin.package:
        name:
          - podman
          - python3-podman
        state: present

    - name: Pull Kafka image to ensure availability
      ansible.builtin.command:
        cmd: "podman pull {{ kafka_image }}"
      changed_when: false

    - name: Stop and Remove existing Kafka container
      ansible.builtin.command:
        cmd: "podman rm -f {{ kafka_container_name }}"
      ignore_errors: true

    - name: Remove Existing Kafka data volume for a clean start
      ansible.builtin.command:
        cmd: "podman volume rm -f kafka_data"
      ignore_errors: true # Ignore if the volume doesn't exist
      # Note: You must remove the volume to truly reset the Kafka state.


    - name: Create Kafka data volume
      containers.podman.podman_volume:
        name: kafka_data

    - name: Start Apache Kafka container (Exposed Externally)
      containers.podman.podman_container:
        name: "{{ kafka_container_name }}"
        image: "{{ kafka_image }}"
        hostname: "{{ kafka_container_name }}"
        state: started
        restart_policy: always
        memory: 2g
        ports:
          - "9092:9092"
          - "9093:9093"
          - "{{ kafka_external_port }}:{{ kafka_external_port }}" # <-- Map External Port
        volumes:
          - "kafka_data:/var/lib/kafka/data"
        env:
          KAFKA_NODE_ID: "1"
          KAFKA_PROCESS_ROLES: "broker,controller"
          # Listeners remain the same (listening on all interfaces via ":port")
          #KAFKA_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:{{ kafka_external_port }}"
          KAFKA_LISTENERS: "CLIENT://:9092,CONTROLLER://:9093"
          
          # CRITICAL CHANGE: Internal Advertised Listener now uses 'service1'
          #KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://service1:9092,EXTERNAL://{{ kafka_external_hostname }}:{{ kafka_external_port }}"
          KAFKA_ADVERTISED_LISTENERS: "CLIENT://{{ kafka_external_hostname }}:9092,CONTROLLER://localhost:9093"
          KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
          
          # 3. Use the new CLIENT listener name
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,CLIENT:PLAINTEXT"
          KAFKA_INTER_BROKER_LISTENER_NAME: "CLIENT" # Set inter-broker to the listener used for clients
          
          KAFKA_CONTROLLER_QUORUM_VOTERS: "1@localhost:9093"
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
          KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
          KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
          KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: "0"
          KAFKA_NUM_PARTITIONS: "3"

    # The following tasks use the internal bootstrap server address (localhost:9092) 
    # which is generally preferred for commands run inside the container.
    - name: List Kafka topics
      ansible.builtin.command:
        cmd: "podman exec {{ kafka_container_name }} /{{ kafka_path }}/kafka-topics.sh --list --bootstrap-server localhost:9092"
      register: topic_list
      changed_when: false
      retries: 5
      delay: 5
      until: topic_list.rc == 0

    - name: Debug Kafka Topics
      ansible.builtin.debug:
        msg:
          - topic_list.stdout_lines "{{ topic_list.stdout_lines }}"
          - topic_list.stdout "{{ topic_list.stdout_lines }}"

    - name: Check if topic exists
      ansible.builtin.command:
        cmd: "podman exec {{ kafka_container_name }} /{{ kafka_path }}/kafka-topics.sh --list --bootstrap-server localhost:9092"
      register: topic_list
      changed_when: false

    - name: Create topic if it doesn't exist
      ansible.builtin.command:
        cmd: "podman exec {{ kafka_container_name }} /{{ kafka_path }}/kafka-topics.sh --create --topic {{ item }} --bootstrap-server localhost:9092 --partitions 1 --replication-factor 1"
      when: item not in topic_list.stdout_lines
      loop: "{{ kafka_topics }}"



    - name: Final check List all created Kafka topics
      ansible.builtin.command:
        cmd: "podman exec {{ kafka_container_name }} /{{ kafka_path }}/kafka-topics.sh --list --bootstrap-server service1:9092"
      register: final_topic_list
      changed_when: false

    - name: Debug Final Kafka Topics List
      ansible.builtin.debug:
        var: final_topic_list.stdout_lines
      