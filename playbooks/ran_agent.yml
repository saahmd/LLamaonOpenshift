---
- name: Agent → Session → LLM Turn (Python streaming)
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Create agent for RCA
      uri:
        url: "https://{{ llama_stack_url }}/v1/agents"
        method: POST
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body: |
         {
            "agent_config": {
             "sampling_params": {"strategy": {"type": "greedy"}, "max_tokens": 3000},
              "model": "granite-8b-lab-v1",
              "instructions": "When an anomaly is detected in the logs, extract the API endpoint and all required JSON parameters (e.g., cell_id, anomaly_type, anomaly_value, threshold_value, action, azimuth_change, downtilt_change). Then generate only one concise fix instruction (1–2 lines) that includes the extracted endpoint and embeds the extracted JSON parameters directly in the instruction, telling the user to make a POST request with this JSON payload. Output only this single fix instruction—no additional text.",
              "enable_session_persistence": false
            }
          }
        body_format: json
        return_content: yes
        validate_certs: no
      register: agent_response

    - name: Create session
      uri:
        url: "https://{{ llama_stack_url }}/v1/agents/{{ agent_response.json.agent_id }}/session"
        method: POST
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body: '{"session_name": "string"}'
        body_format: json
        return_content: yes
        validate_certs: no
      register: session_response

    - name: Create turn
      uri:
        url: "https://{{ llama_stack_url }}/v1/agents/{{ agent_response.json.agent_id }}/session/{{ session_response.json.session_id }}/turn"
        method: POST
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body: |
          {
            "messages": [
              {
                "role": "user",
                "content": "{{ full_anomaly_report | default('What is the capital of the USA?') }}",
                "context": "string"
              }
            ],
            "stream": true,
            "tool_config": {
              "tool_choice": "auto"
            }
          }
        body_format: json
        return_content: yes
        validate_certs: no
      register: turn_response_gpt

    - name: Display Turn response
      ansible.builtin.debug:
        msg: "{{ turn_response_gpt.content }}"

    - name: Extract JSON string from turn_response_gpt.content
      ansible.builtin.set_fact:
       json_string: "{{ turn_response_gpt.content | regex_replace('^data:\\s*', '') }}"

    - name: Parse JSON
      ansible.builtin.set_fact:
        json_clean: >-
          {{ json_string[ json_string.find('{') : json_string.rfind('}') + 1 ] }}


    - name: Extract last JSON object from json_clean
      set_fact:
        last_json: "{{ json_clean | regex_findall('({.*})') | last }}"
        

    - name: Extract GPT Response
      ansible.builtin.set_fact:
        gpt_response: "{{ json_clean.event.payload.turn.output_message.content }}"

    - name: Display GPT Response
      ansible.builtin.debug:
        msg: "{{ gpt_response }}"

    #- name: Extract GPT Response as string
    #  ansible.builtin.set_fact:
    #    gpt_response: "{{ (turn_response_gpt.content | regex_search('\"output_message\".*?\"content\":\"([^\"]+)\"', '\\1'))[0] }}"

    #- name: Display GPT Response
    #  ansible.builtin.debug:
    #    msg: "{{ gpt_response }}"


   